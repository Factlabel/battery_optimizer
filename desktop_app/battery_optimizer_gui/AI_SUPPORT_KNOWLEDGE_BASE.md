# Battery Optimizer AI Support Knowledge Base - 完全版

## 📋 システム概要

Battery Optimizerは日本の電力市場（JEPX、EPRX1、EPRX3）における蓄電池の最適運用を計算するシステムです。

### アプリケーション構成
- **デスクトップ版**: PyQt6ベースのネイティブアプリケーション（推奨）
- **Web版**: Streamlitベースのブラウザアプリケーション

### 主要機能
1. **最適化エンジン**: 数理最適化による収益最大化
2. **多市場対応**: JEPX、EPRX1、EPRX3の同時最適化
3. **AI分析支援**: OpenAI GPTによるデータ分析
4. **可視化機能**: 豊富なグラフとチャート
5. **データエクスポート**: CSV、画像、レポート出力

### 計算原理
最適化は**線形計画法**を使用し、以下を目的とします：
- **目的関数**: 収益最大化（収入 - コスト）
- **制約条件**: バッテリー容量、出力制限、市場ルール
- **ソルバー**: CBC（Coin-or Branch and Cut）

## 🚀 よくある質問とトラブルシューティング

### Q1: アプリケーションが起動しない
**症状**: ダブルクリックしてもアプリが開かない

**解決手順**:
1. **ターミナルから起動確認**:
   ```bash
   cd desktop_app/battery_optimizer_gui
   python main.py
   ```

2. **CBCソルバー確認**:
   ```bash
   python setup.py
   ```

3. **依存関係の再インストール**:
   ```bash
   pip install -r requirements.txt
   ```

### Q2: CBCソルバーエラー
**症状**: "PULP_CBC_CMD: Not Available" エラー

**解決方法**:
1. **自動修復実行**:
   ```bash
   python setup.py
   ```

2. **Homebrewでのインストール（macOS）**:
   ```bash
   brew install cbc
   ```

3. **手動権限設定**:
   ```bash
   chmod +x .venv/lib/python*/site-packages/pulp/solverdir/cbc/*/cbc
   ```

### Q3: 最適化が失敗する・遅い
**症状**: 計算が途中で止まる、時間がかかりすぎる

**解決方法**:
1. **パフォーマンスモードを高速に変更**:
   - GUI: 「エンジンバージョン」→「V1 (高速モード)」選択

2. **予測対象スロット数を削減**:
   - 168 → 48-96に設定変更

3. **データサイズを確認**:
   - 10,000スロット超の場合は分割処理を推奨

### Q4: 日付選択がうまくできない
**症状**: カレンダーから選択したい

**機能**: 
- 期間指定モードでカレンダーボタン（📅）をクリック
- カレンダーダイアログから直感的に日付選択可能

### Q5: グラフの文字が小さい/読みにくい
**対応済み**: v2.0で改善
- 時間別収益分布の数字: フォントサイズ6に調整
- 日付表示: 2023→23の短縮形式
- 全体的なフォント最適化

### Q6: CSVファイルを読み込めない
**症状**: 「ファイル形式が不正です」エラー

**解決手順**:
1. **文字エンコーディング確認**: UTF-8で保存されているか確認
2. **列名チェック**: 必須列が全て含まれているか確認
3. **データ型確認**: 数値列に文字が混入していないか確認
4. **日付形式**: YYYY-MM-DD形式になっているか確認

### Q7: 最適化結果で「収益がマイナス」になる
**原因と対策**:
1. **托送料金が高すぎる**: エリア設定を確認
2. **バッテリー損失率が高すぎる**: 現実的な値（3-8%）に設定
3. **価格データに問題**: 異常に高い負の価格が含まれていないか確認

### Q8: AIが「データがありません」と回答する
**症状**: 最適化後でもAIがデータを認識しない

**解決手順**:
1. **📊 送信データ確認**ボタンでデータ内容を確認
2. **最適化の完了確認**: エラーで中断していないかチェック
3. **APIキーの確認**: OpenAI API設定が正しいか確認

### Q9: 「メモリ不足」エラーが発生する
**対策**:
1. **データサイズ削減**: 期間を短縮（例：1年→3ヶ月）
2. **予測スロット数削減**: 168 → 48に変更
3. **他のアプリケーション終了**: メモリを解放

### Q10: macOSで「開発元が未確認」エラー
**解決方法**:
1. **システム環境設定** → **セキュリティとプライバシー**
2. **「このまま開く」**をクリック
3. またはターミナルから起動: `python main.py`

## 🖥️ UI操作完全ガイド

### メイン画面の構成
1. **上部メニューバー**: 設定、ヘルプ、情報
2. **左側パネル**: パラメータ設定とファイル操作
3. **右側パネル**: 結果表示（5つのタブ）
4. **下部ログエリア**: 処理状況とメッセージ

### 左側パネル詳細操作

#### ファイル操作セクション
- **「CSVファイルを選択...」**: 市場価格データの読み込み
- **「テンプレートダウンロード」**: サンプルCSVファイルの取得
- **読み込み状況表示**: ファイル名、行数、日付範囲を表示

#### パラメータ設定セクション
1. **基本設定**:
   - **バッテリー出力(kW)**: 1スロット（30分）あたりの最大充放電量
   - **バッテリー容量(kWh)**: 蓄電池の総容量（実効容量を入力）
   - **損失率(%)**: 充放電時のエネルギー損失（通常3-8%）
   - **初期残量(kWh)**: 最適化開始時のバッテリー残量

2. **高度な設定**（展開可能）:
   - **エンジンバージョン**: V1（高速）、V2（標準）、V2-full（完全）
   - **エリア選択**: 9エリア（東北、東京、中部、関西、中国、四国、九州、北海道、沖縄）
   - **予測対象スロット数**: 最適化計算する未来のスロット数（48推奨）

#### 制御ボタン
- **「最適化を実行」**: 計算開始（緑色ボタン）
- **「キャンセル」**: 計算中断（赤色ボタン、計算中のみ表示）
- **「パラメータリセット」**: 設定値を初期化

### 右側パネル詳細操作

#### 1. グラフタブ
**期間選択機能**:
- **全期間**: データ全体を表示
- **最近7日**: 直近1週間
- **最近30日**: 直近1ヶ月
- **期間指定**: カレンダー（📅）から日付選択

**表示内容**:
- **青線**: バッテリー残量推移（SOC）
- **赤線**: JEPX価格推移
- **背景色**: アクション（充電=青、放電=赤、調整力=黄）

#### 2. 収益詳細タブ
**4つのサブグラフ**:
- **左上**: 時間別収益分布（どの時間が稼げるか）
- **右上**: 市場別収益貢献（JEPX vs EPRX1 vs EPRX3）
- **左下**: アクション分布（充電・放電・調整力の割合）
- **右下**: 日別収益推移（日々の収益変化）

#### 3. 詳細データタブ
- **全データ表示**: すべてのスロットの最適化結果
- **CSVエクスポート**: 結果データをファイル保存
- **ソート機能**: 列をクリックで並び替え

#### 4. サマリータブ
**財務サマリー**:
- **総収益**: 全期間の収入合計
- **総コスト**: 託送料金+再エネ賦課金の合計
- **純利益**: 収益 - コスト

**運用統計**:
- **平均SOC**: バッテリー残量の平均値
- **稼働率**: アクティブなスロットの割合

#### 5. AI分析チャットタブ
**機能ボタン**:
- **📊 送信データ確認**: AIに送信される内容の確認
- **🐛 問題報告**: エラーや不具合の報告
- **🤖 AIサポートデスク**: 使い方ガイドとサンプル質問

**質問のコツ**:
- 具体的な数値や期間を含める
- 「なぜ」「どのように」で始まる質問が効果的
- エラーの場合は症状を詳しく説明

## 📊 データ仕様

### 必須CSVフォーマット
```csv
date,slot,JEPX_prediction,JEPX_actual,EPRX1_prediction,EPRX1_actual,EPRX3_prediction,EPRX3_actual,imbalance
2024-01-01,1,10.5,10.8,15.2,15.0,20.1,19.8,12.3
2024-01-01,2,9.8,10.2,15.1,14.9,19.8,20.1,11.8
```

### 列の詳細説明
1. **date**: 日付（YYYY-MM-DD形式必須）
2. **slot**: スロット番号（1-48、30分単位）
3. **JEPX_prediction**: JEPX価格予測値（円/kWh）
4. **JEPX_actual**: JEPX価格実績値（円/kWh）
5. **EPRX1_prediction**: 一次調整力価格予測（円/kW/h）
6. **EPRX1_actual**: 一次調整力価格実績（円/kW/h）
7. **EPRX3_prediction**: 三次調整力価格予測（円/kW/h）
8. **EPRX3_actual**: 三次調整力価格実績（円/kW/h）
9. **imbalance**: インバランス価格（円/kWh）

### データ品質チェックポイント
1. **日付形式**: YYYY-MM-DD（ISO形式必須）
2. **スロット連続性**: 1-48の連続した整数（欠番なし）
3. **価格データ**: 負の値も許可（価格がマイナスの場合あり）
4. **欠損値**: 空白やNaNは自動で0に変換
5. **データ型**: 数値列に文字列が混入していないこと

### データ準備のベストプラクティス
1. **Excelでの保存**: 「CSV UTF-8」形式で保存
2. **データ検証**: テンプレートと照合
3. **期間統一**: 連続した日付データを準備
4. **価格範囲**: 異常値（100円/kWh超など）をチェック

## ⚙️ パラメータ設定完全ガイド

### 🏢 エリア・電圧設定

#### 対象エリア
**選択肢**: 9エリア（1:北海道、2:東北、3:東京、4:中部、5:北陸、6:関西、7:中国、8:四国、9:九州）
**デフォルト**: 3 (東京)
**影響**: 託送料金、損失率、再エネ賦課金の自動設定
**注意**: 実際の運用エリアと一致させることが重要

#### 電圧区分
**選択肢**:
- **SHV (特高圧)**: 66kV以上、大規模産業用
- **HV (高圧)**: 6.6kV、中規模商業・工業用
- **LV (低圧)**: 100V/200V、小規模・住宅用

**デフォルト**: HV (高圧)
**影響**: 託送基本料金と使用料の料金体系
**選択基準**: 実際の契約電圧に合わせて選択

### 🔋 バッテリーシステム設定

#### バッテリー出力 (kW)
**設定範囲**: 10〜100,000 kW
**デフォルト**: 1000 kW
**意味**: 1スロット（30分）あたりの最大充放電量
**計算式**: 実際の瞬間最大出力 × 0.5（30分平均）
**設定例**:
- **小規模**: 500kW（家庭用蓄電池群）
- **中規模**: 1,000〜5,000kW（商業・産業用）
- **大規模**: 10,000kW以上（電力会社・大規模事業者）

#### バッテリー容量 (kWh)
**設定範囲**: 10〜1,000,000 kWh
**デフォルト**: 4000 kWh
**重要**: カタログ容量でなく、実際に使用可能な**実効容量**を入力
**実効容量の計算**:
```
実効容量 = カタログ容量 × 使用可能SOC範囲 × 劣化係数
例: 5000kWh × 0.9 (10-100%使用) × 0.95 (劣化5%) = 4275kWh
```

#### 初期蓄電量 (kWh)
**設定範囲**: 0〜バッテリー容量
**デフォルト**: 2000 kWh（容量の50%）
**エンジン別動作**:
- **V1エンジン**: この設定は無視され、常に容量の50%からスタート
- **V2エンジン**: 設定値通りの残量からスタート
**実運用**: 実際の運用開始時の蓄電量に合わせて設定

#### バッテリー損失率 (%)
**設定範囲**: 0〜50%
**デフォルト**: 5%
**意味**: 充放電時のエネルギー損失（ラウンドトリップ効率の逆数）
**計算式**: 損失率 = (1 - ラウンドトリップ効率) × 100
**実測値例**:
- **リチウムイオン（新品）**: 3〜5%
- **リチウムイオン（劣化後）**: 5〜8%
- **NAS電池**: 15〜20%
- **揚水発電**: 20〜25%

### ⚙️ 詳細設定項目

#### 日次サイクル上限
**設定範囲**: 0〜10回/日（0=制限なし）
**デフォルト**: 1回/日
**意味**: 1日あたりの充放電サイクル数の制限
**目的**: バッテリー劣化抑制、運用負荷軽減、バッテリーメーカー保証
**推奨設定**:
- **劣化重視**: 1回/日
- **収益重視**: 2〜3回/日
- **制限なし**: 0（短期運用時）

#### 予測対象スロット数
**設定範囲**: 24〜168スロット
**デフォルト**: 48スロット（1日分）
**意味**: 同時に最適化する未来のスロット数
**パフォーマンス影響**:
- **24スロット**: 超高速、精度やや低
- **48スロット**: 高速、バランス良好（推奨）
- **96スロット**: 中速、高精度
- **168スロット**: 低速、最高精度

### 🔧 EPRX1調整力設定

#### EPRX1連続スロット数
**設定範囲**: 1〜12スロット
**デフォルト**: 3スロット（1.5時間）
**意味**: EPRX1を選択した場合の連続運用時間
**市場ルール**: 実際は6スロット（3時間）が最低単位
**設定指針**:
- **短時間**: 1〜2スロット（柔軟性重視）
- **標準**: 3〜4スロット（市場準拠）
- **長時間**: 6〜8スロット（安定性重視）

#### EPRX1クールダウン
**設定範囲**: 0〜12スロット
**デフォルト**: 2スロット（1時間）
**意味**: EPRX1ブロック終了後の待機時間
**目的**: EPRX1提供後のSoC調整時間
**推奨設定**: 実際の1次調整力提供後の平均SoCから決定

#### EPRX1日次上限
**設定範囲**: 0〜48スロット（0=制限なし）
**デフォルト**: 6スロット（3時間）
**意味**: 1日あたりのEPRX1運用可能スロット数
**制約理由**: 契約制限、システム負荷軽減

### 📊 長期運用設定

#### 年間サイクル上限
**設定範囲**: 0〜5000サイクル（0=制限なし）
**デフォルト**: 365サイクル（1日1回×1年）
**意味**: 年間の総充放電サイクル数制限
**劣化との関係**: サイクル数 ↑ → 劣化速度 ↑
**設定例**:
- **保守的**: 300サイクル/年
- **標準**: 365サイクル/年
- **積極的**: 500〜730サイクル/年

#### 年間劣化率 (%)
**設定範囲**: 0〜10%
**デフォルト**: 3%
**意味**: 1年間での容量劣化率
**実測値**:
- **リチウムイオン**: 2〜5%/年
- **NAS電池**: 1〜3%/年
**影響**: 長期収益計算、交換時期予測

### 🎲 V2エンジン専用設定

#### EPRX3発動率 (%)
**設定範囲**: 0〜100%
**デフォルト**: 100%（従来動作）
**意味**: EPRX3が選択された時の実際の発動確率
**新機能**: V2エンジンでより現実的な確率モデル
**設定例**:
- **確実**: 100%（従来通り）
- **現実的**: 70〜80%（市場実績ベース）
- **保守的**: 50〜60%（リスク重視）

#### V1価格比率 (%)
**設定範囲**: 0〜200%
**デフォルト**: 100%（インバランス価格と同等）
**意味**: EPRX3発動時のV1調整価格をインバランス価格に対する比率で設定
**計算式**: V1価格 = インバランス価格 × V1価格比率
**設定例**:
- **保守的**: 80〜90%（安全マージン）
- **標準**: 100%（市場価格準拠）
- **積極的**: 110〜120%（プレミアム期待）

### 🚀 エンジンバージョン選択

#### V1 (従来版)
**特徴**: 高速処理、EPRX3は100%発動
**用途**: 日常的な最適化、大規模データ
**制約**: EPRX1制約簡素化
**処理速度**: 最高速
**推奨**: 一般的な運用、パフォーマンス重視

#### V2 (EPRX3確率版)
**特徴**: 確率的EPRX3発動、V1価格調整
**用途**: より現実的なモデリング
**制約**: 完全なEPRX1制約
**処理速度**: 中程度
**推奨**: 精密な分析、リスク評価

### 💡 パラメータ設定のベストプラクティス

#### 初期設定手順
1. **エリア・電圧**: 実際の契約情報に合わせる
2. **バッテリー仕様**: 実効容量を正確に算出
3. **損失率**: 実測値または仕様書の値を使用
4. **運用制約**: 保守的な値から開始
5. **段階的調整**: 結果を見ながら徐々に最適化

#### 性能重視の設定
- エンジン: V1
- 予測スロット: 48
- EPRX1制約: 緩め（大きな値）
- サイクル制限: 制限なし（0）

#### 精度重視の設定
- エンジン: V2
- 予測スロット: 96〜168
- EPRX1制約: 実運用に準拠
- 確率パラメータ: 実績ベース

#### 安全重視の設定
- 日次サイクル: 1回
- 年間サイクル: 300回
- 劣化率: 実測値より高めに設定
- EPRX3発動率: 保守的（70%以下）

## 🎯 パフォーマンス最適化

### モード選択指針
1. **高速モード (V1)**: 
   - 用途: 日常的な最適化業務
   - 制約: EPRX1制約なし
   - 速度: 最高速（推奨）

2. **標準モード (V2-basic)**:
   - 用途: EPRX1も考慮したい場合
   - 制約: 簡易EPRX1制約
   - 速度: 中程度

3. **完全モード (V2-full)**:
   - 用途: Streamlit版との完全一致が必要
   - 制約: 全制約条件
   - 速度: 最も詳細だが時間要

### データサイズ別推奨設定
| データサイズ | 推奨モード | 予測スロット数 | 想定処理時間 |
|--------------|------------|----------------|--------------|
| ~1,000スロット | 高速 | 48 | 5-10秒 |
| ~5,000スロット | 高速 | 48-96 | 30-60秒 |
| ~10,000スロット | 高速 | 48 | 1-2分 |
| 10,000スロット超 | 高速 | 48 | データ分割推奨 |

## 💰 託送料金・損失率設定詳細

### 託送料金の構造
**基本料金**: バッテリー出力(kW)に基づく固定費
**使用料**: 電力使用量(kWh)に基づく従量料金
**計算式**:
```
月額託送料金 = (基本料金 × バッテリー出力) + (使用料 × 月間電力量)
```

### エリア別託送料金設定

#### 北海道電力エリア
**特高圧(SHV)**: 基本476.19円/kW、使用料0.80円/kWh、損失率1.8%
**高圧(HV)**: 基本683.10円/kW、使用料2.42円/kWh、損失率6.0%
**低圧(LV)**: 基本395.56円/kW、使用料6.19円/kWh、損失率8.6%

#### 東北電力エリア
**特高圧(SHV)**: 基本395.56円/kW、使用料0.72円/kWh、損失率1.8%
**高圧(HV)**: 基本683.10円/kW、使用料2.42円/kWh、損失率6.0%
**低圧(LV)**: 基本395.56円/kW、使用料6.19円/kWh、損失率8.6%

#### 東京電力エリア（デフォルト）
**特高圧(SHV)**: 基本476.19円/kW、使用料0.67円/kWh、損失率2.9%
**高圧(HV)**: 基本683.10円/kW、使用料1.86円/kWh、損失率7.8%
**低圧(LV)**: 基本395.56円/kW、使用料5.55円/kWh、損失率8.6%

#### 中部電力エリア
**特高圧(SHV)**: 基本439.01円/kW、使用料0.74円/kWh、損失率2.9%
**高圧(HV)**: 基本609.40円/kW、使用料2.05円/kWh、損失率7.3%
**低圧(LV)**: 基本378.40円/kW、使用料4.88円/kWh、損失率7.8%

#### 関西電力エリア
**特高圧(SHV)**: 基本440.00円/kW、使用料0.84円/kWh、損失率2.9%
**高圧(HV)**: 基本663.30円/kW、使用料2.29円/kWh、損失率7.8%
**低圧(LV)**: 基本378.40円/kW、使用料4.69円/kWh、損失率7.8%

### 託送料金カスタマイズ機能
**アクセス方法**: 設定画面 → 「託送料金・損失率」タブ
**編集可能項目**:
- 各エリア・電圧別の損失率
- 託送基本料金（円/kW）
- 託送使用料（円/kWh）
- 再エネ賦課金（円/kWh）

**編集手順**:
1. テーブルの該当セルをダブルクリック
2. 新しい値を入力
3. 「保存」ボタンで変更を確定
4. 「リセット」ボタンでデフォルト値に復元

### 再エネ賦課金
**デフォルト値**: 3.49円/kWh（2024年度）
**自動更新**: 年度ごとに政府発表値に更新
**影響**: 全ての充放電量に対して課金

## ⚙️ 一般設定・環境設定

### ログレベル設定
**選択肢**: ERROR、WARNING、INFO、DEBUG
**デフォルト**: INFO
**各レベルの内容**:
- **ERROR**: エラーメッセージのみ表示
- **WARNING**: 警告とエラーを表示
- **INFO**: 一般的な処理状況も表示（推奨）
- **DEBUG**: 詳細な内部処理も表示（トラブル時）

### 自動保存設定
**デフォルト**: 有効
**動作**: 最適化完了時に結果を自動保存
**保存場所**: アプリケーションフォルダ内の`results/`
**ファイル形式**: CSV、JSON、画像ファイル

### テーマ設定
**選択肢**: ライト、ダーク
**デフォルト**: ライト
**影響**: UI全体の配色（将来的に実装予定）

### OpenAI API詳細設定

#### APIキー管理
**形式**: sk-で始まる文字列
**保存場所**: システムの設定ファイル（暗号化）
**セキュリティ**: マスク表示、最後4文字のみ可視

#### API使用量管理
**課金体系**: トークン数ベースの従量課金
**推定コスト**: 1回の質問あたり約1〜5円
**節約方法**: 簡潔な質問、頻繁でない利用

#### 接続テスト機能
**目的**: APIキーの有効性確認
**テスト内容**: "Hello"メッセージでの簡単な疎通確認
**結果表示**: 成功/失敗メッセージ

### メール通知設定

#### SMTP設定
**対応サーバー**: Gmail、Outlook、独自SMTPサーバー
**必要情報**: SMTPサーバー、ポート番号、認証情報
**暗号化**: TLS/SSL対応

#### 通知タイミング
**最適化完了**: 処理完了時の自動通知
**エラー発生**: 重大なエラー時の即座通知
**定期レポート**: 日次・週次の運用レポート（将来実装）

### パフォーマンス設定

#### メモリ使用量制限
**自動調整**: データサイズに応じた動的制限
**手動設定**: 上級者向けメモリ制限設定（将来実装）

#### CPU使用率制限
**並列処理**: 最適化計算での CPU コア数制御
**バックグラウンド**: 他のアプリケーションへの影響軽減

### データ管理設定

#### 一時ファイル管理
**自動クリーンアップ**: 古い一時ファイルの定期削除
**保存期間**: デフォルト30日間
**手動削除**: 設定画面からの即座削除機能

#### バックアップ設定
**自動バックアップ**: 設定ファイルの定期バックアップ
**復元機能**: 設定の誤変更時の復元機能
**エクスポート**: 設定のファイル出力（移行用）

## 📈 結果の読み方

### アクション種別
- **charge**: 市場から充電（JEPX安い時間）
- **discharge**: 市場へ放電（JEPX高い時間）
- **eprx1**: 一次調整力でブロック収益
- **eprx3**: 三次調整力で基本収益+インバランス調整
- **idle**: 待機状態

### 収益構造の詳細解説

#### 1. JEPX収益（エネルギー取引）
**計算式**:
```
JEPX収益 = (放電量 × JEPX価格) - (充電量 × JEPX価格)
```
**具体例**:
- 深夜(3時): 8円/kWhで1000kWh充電 → コスト8,000円
- 昼間(13時): 18円/kWhで1000kWh放電 → 収入18,000円
- **差益**: 10,000円（損失とコストは別途）

#### 2. EPRX1収益（一次調整力）
**計算式**:
```
EPRX1収益 = 確保容量(kW) × EPRX1価格(円/kW/h) × 運用時間(h)
```
**具体例**:
- 確保容量: 1000kW
- EPRX1価格: 15円/kW/h
- 運用時間: 2時間ブロック
- **収益**: 1000kW × 15円/kW/h × 2h = 30,000円

#### 3. EPRX3収益（三次調整力）
**基本料金**:
```
基本収益 = 確保容量(kW) × EPRX3価格(円/kW/h) × 運用時間(h)
```
**調整収益**:
```
調整収益 = 実調整量(kWh) × インバランス価格(円/kWh)
```
**具体例**:
- 基本: 1000kW × 20円/kW/h × 0.5h = 10,000円
- 調整: 500kWh × 12円/kWh = 6,000円
- **合計**: 16,000円

#### 4. コスト構造
**託送料金**:
```
託送コスト = 基本料金 + (充放電量 × 使用料)
```
**再エネ賦課金**:
```
賦課金 = 充放電量 × 3.49円/kWh
```
**バッテリー損失**:
```
損失コスト = 充電量 × 損失率 × JEPX価格
```

## 🔋 日本の電力市場詳細解説

### JEPX（日本卸電力取引所）
**運営主体**: 日本卸電力取引所
**取引時間**: 30分単位（スロット1〜48）
**価格決定**: 需給バランスによる市場価格
**価格範囲**: -200円/kWh〜200円/kWh
**特徴**:
- リアルタイム価格変動
- 需要増加時に価格上昇
- 再エネ大量発電時に価格下落（負価格もあり）

### EPRX1（一次調整力）
**目的**: 周波数制御（50Hz/60Hz維持）
**応答時間**: 10秒以内
**継続時間**: 通常2時間ブロック
**入札方式**: 容量確保による固定収入
**市場開設**: 2016年
**価格水準**: 10〜30円/kW/h程度

### EPRX3（三次調整力）
**目的**: 需給調整、インバランス対応
**応答時間**: 15分以内
**継続時間**: 状況に応じて可変
**収益構造**: 基本料金 + 調整指令による従量収入
**価格特性**: インバランス価格に連動
**発動確率**: 80〜90%程度（実績ベース）

### インバランス料金
**発生原因**: 計画値と実績値の差異
**価格設定**: 30分ごとに算定
**方向性**:
- **余剰インバランス**: 電力余り→価格下落
- **不足インバランス**: 電力不足→価格上昇

## 📊 実用的な運用シナリオ例

### シナリオ1: 日中太陽光大量発電日
**市場状況**:
- 10-14時: JEPX価格が5円/kWh以下
- 19-21時: JEPX価格が25円/kWh以上

**最適戦略**:
1. 10-12時: 太陽光余剰で安価に充電
2. 19-21時: 需要ピークで高価格放電
3. EPRX3待機: 夕方の急激な需要変動に対応

**期待収益**:
- JEPX差益: (25-5) × 1000kWh = 20,000円
- EPRX3収益: 約10,000円
- **合計**: 約30,000円/日

### シナリオ2: 冬季暖房需要ピーク日
**市場状況**:
- 深夜2-5時: JEPX価格 12円/kWh
- 朝夕ピーク: JEPX価格 35円/kWh以上
- EPRX1価格高騰: 25円/kW/h

**最適戦略**:
1. 深夜充電: 12円/kWhで充電
2. 朝ピーク: EPRX1ブロック運用
3. 夕ピーク: 高価格放電

**期待収益**:
- JEPX差益: (35-12) × 800kWh = 18,400円
- EPRX1収益: 1000kW × 25円/kW/h × 2h = 50,000円
- **合計**: 約68,400円/日

### シナリオ3: 平常時安定運用
**市場状況**:
- 価格変動小: 10-15円/kWh程度
- 調整力価格安定: EPRX1 15円/kW/h

**最適戦略**:
1. 小さな価格差を狙った充放電
2. EPRX3中心の安定収益確保
3. 劣化抑制で長期運用

**期待収益**:
- JEPX差益: 控えめ 3,000円/日
- EPRX3収益: 安定 15,000円/日
- **合計**: 約18,000円/日

## 💡 収益最大化のプロ向けテクニック

### 価格予測精度向上
1. **気象データ活用**: 太陽光・風力の発電量予測
2. **需要パターン分析**: 曜日・季節・イベントによる需要変動
3. **機械学習適用**: 過去データからの価格予測モデル

### ポートフォリオ最適化
1. **リスク分散**: JEPX・EPRX1・EPRX3の最適配分
2. **確率論的アプローチ**: 価格変動の不確実性考慮
3. **動的戦略**: 市場状況に応じたリアルタイム戦略変更

### システム統合
1. **EMSとの連携**: 他の分散電源との協調制御
2. **需要家負荷との連携**: 需要制御との組み合わせ
3. **VPP参加**: 仮想発電所への参加による規模効果

### グラフの見方
- **時間別収益分布**: どの時間帯が収益性が高いか
- **市場別収益貢献**: JEPX vs EPRX1 vs EPRX3の貢献度
- **アクション分布**: どの運用パターンが多いか
- **日別収益推移**: 期間全体の収益トレンド

## 🔧 システム要件・制限事項

### 動作環境
- **OS**: macOS 10.14+、Windows 10+、Linux
- **Python**: 3.8以上
- **メモリ**: 4GB以上（大規模データは8GB推奨）
- **ストレージ**: 1GB以上の空き容量

### 制限事項
- **最大データサイズ**: 100,000スロット程度（メモリ依存）
- **並行処理**: 単一バッテリーサイトのみ
- **市場対応**: 日本の電力市場のみ

## 🤖 AI機能完全ガイド

### OpenAI API設定
1. **設定手順**:
   - 右上の⚙️ボタン → 「設定」
   - 「🤖 AI設定」タブを選択
   - APIキーを入力（sk-で始まる文字列）
   - 「APIテスト」で接続確認

2. **APIキーの取得方法**:
   - OpenAI公式サイト（platform.openai.com）でアカウント作成
   - API Keysページでキー生成
   - 使用量に応じた課金

### AI分析の活用方法

#### データ分析質問例
**収益分析**:
- 「今回の最適化で最も収益性の高い時間帯はいつですか？」
- 「JEPX、EPRX1、EPRX3のうち、どれが最も収益に貢献していますか？」
- 「平均的な1日の収益はいくらですか？」

**運用分析**:
- 「バッテリーの稼働率はどの程度ですか？」
- 「充電と放電の回数はそれぞれ何回ですか？」
- 「最もバッテリーを使用した日はいつですか？」

**パフォーマンス分析**:
- 「予測と実績の価格差が大きい日はありますか？」
- 「損失率を下げるとどの程度収益が改善しますか？」
- 「このデータから改善できるポイントはありますか？」

#### トラブルシューティング質問例
- 「最適化が遅い理由と改善方法を教えてください」
- 「CSVファイルの準備方法を教えてください」
- 「エラーメッセージの意味と対処法を教えてください」

### AI回答の信頼性
- **データベース**: 最適化結果の実データを参照
- **知識**: 電力市場とシステムの専門知識
- **制限**: AIは最新の市場情報は持たない

## 📞 エラーコード・ログ解釈

### 詳細エラーメッセージ一覧

#### ファイル関連エラー
1. **"ファイルが見つかりません"**:
   - 原因: 指定したCSVファイルが存在しない
   - 対策: ファイルパスを確認、ファイルの存在確認

2. **"CSVフォーマットが不正です"**:
   - 原因: 必須列が不足、列名の誤字
   - 対策: テンプレートと比較、列名の確認

3. **"文字エンコーディングエラー"**:
   - 原因: ファイルがUTF-8以外で保存されている
   - 対策: Excelで「CSV UTF-8」として再保存

#### データ関連エラー
4. **"日付形式が不正です"**:
   - 原因: YYYY-MM-DD以外の形式
   - 対策: Excel日付書式をISO形式に変更

5. **"スロット番号が不正です"**:
   - 原因: 1-48以外の値、欠番
   - 対策: スロット列の連続性確認

6. **"数値データに文字が含まれています"**:
   - 原因: 価格列に文字列が混入
   - 対策: データクリーニング、数値変換

#### 最適化関連エラー
7. **"No solution found"**:
   - 原因: 制約条件が厳しすぎる、データ不整合
   - 対策: パラメータ緩和、データ確認

8. **"Solver not available"**:
   - 原因: CBCソルバーが正しくインストールされていない
   - 対策: `python setup.py`実行、権限設定

9. **"Memory error"**:
   - 原因: データサイズ過大、メモリ不足
   - 対策: データ分割、予測スロット数削減

#### API関連エラー
10. **"OpenAI API key not found"**:
    - 原因: APIキーが設定されていない
    - 対策: 設定画面でAPIキー入力

11. **"API rate limit exceeded"**:
    - 原因: API使用制限に達した
    - 対策: 時間をおいて再試行、プラン確認

12. **"Invalid API response"**:
    - 原因: AIサーバーの問題、ネットワーク問題
    - 対策: 再試行、ネットワーク確認

### ログレベルと対応
- **INFO**: 正常な処理状況（緑色で表示）
- **WARNING**: 注意が必要だが処理継続（黄色で表示）
- **ERROR**: 処理が中断される問題（赤色で表示）
- **DEBUG**: 詳細な内部処理情報（グレーで表示）

### ログの活用方法
1. **問題発生時**: ERRORレベルのメッセージを最初に確認
2. **パフォーマンス確認**: 処理時間のINFOメッセージを参照
3. **データ検証**: WARNINGメッセージでデータ品質を確認

## 🔄 バージョン間の違い

### デスクトップ版 vs Web版
| 機能 | デスクトップ版 | Web版 |
|------|----------------|-------|
| パフォーマンス | 高速 | 中程度 |
| データサイズ | 大容量対応 | 制限あり |
| UI/UX | ネイティブ | ブラウザ依存 |
| インストール | 必要 | 不要 |
| オフライン利用 | 可能 | 不可 |

### エンジンバージョン
- **V1**: 高速、制約簡素化
- **V2**: 完全制約、Streamlit版準拠

## 💡 最適化のコツ

### 収益最大化のポイント
1. **価格予測精度**: より正確な予測データの使用
2. **損失率最小化**: 効率的なバッテリーシステム
3. **制約の適切な設定**: 過度に厳しい制約を避ける
4. **市場選択**: EPRX1/EPRX3の戦略的活用

### データ品質向上
1. **予測vs実績**: 予測精度の継続的改善
2. **欠損値対応**: 補間や除外の適切な判断
3. **異常値除去**: 明らかに不正な価格データの修正

## 🎓 初心者向けステップバイステップガイド

### ステップ1: 環境準備
1. **アプリケーション起動**:
   ```bash
   cd desktop_app/battery_optimizer_gui
   python main.py
   ```

2. **初回設定確認**:
   - CBCソルバーが利用可能かチェック
   - 依存関係が正しくインストールされているか確認

### ステップ2: サンプルデータで練習
1. **テンプレートダウンロード**:
   - 「テンプレートダウンロード」ボタンクリック
   - サンプルCSVファイルを保存

2. **基本パラメータ設定**:
   - バッテリー出力: 1000kW
   - バッテリー容量: 4000kWh
   - 損失率: 5%
   - 初期残量: 2000kWh

3. **初回最適化実行**:
   - 「最適化を実行」ボタンクリック
   - 処理完了まで待機（通常1-2分）

### ステップ3: 結果の確認と理解
1. **グラフタブ確認**:
   - バッテリー残量推移を観察
   - JEPX価格と充放電タイミングの関係確認

2. **収益詳細確認**:
   - どの時間帯が最も収益性が高いか確認
   - 市場別の収益貢献度確認

3. **サマリータブ確認**:
   - 総収益、総コスト、純利益の確認
   - 投資回収期間の概算

### ステップ4: 実データでの運用
1. **実データ準備**:
   - 自社の価格予測データをCSV形式で準備
   - テンプレートに合わせてフォーマット調整

2. **パラメータ調整**:
   - 実際のバッテリーシステムに合わせて設定
   - エリア設定の確認

3. **継続的な最適化**:
   - 定期的なデータ更新
   - 予測精度の改善

## 🔬 計算ロジック詳細解説

### 最適化問題の数式
**目的関数**:
```
max Σ(JEPX収益 + EPRX1収益 + EPRX3収益 - コスト)
```

**制約条件**:
1. **バッテリー容量制約**: 0 ≤ SOC ≤ 最大容量
2. **出力制約**: |充放電量| ≤ 最大出力
3. **連続性制約**: SOC[t+1] = SOC[t] + 充電量 - 放電量 - 損失
4. **市場制約**: EPRX1ブロック制約、クールダウン制約

### 収益計算の詳細
**JEPX収益**:
```
放電量 × JEPX価格 - 充電量 × JEPX価格
```

**EPRX1収益**:
```
確保容量 × EPRX1価格 × ブロック時間
```

**EPRX3収益**:
```
(基本料金 × 確保容量) + (インバランス価格 × 調整量)
```

**コスト計算**:
```
(充電量 + 放電量) × (託送料金 + 再エネ賦課金) + 損失コスト
```

### アルゴリズムの特徴
1. **線形計画法**: 最適解の保証
2. **混合整数**: EPRX1ブロック制約の考慮
3. **動的制約**: 時間依存の制約条件

## 📈 高度な運用戦略

### 収益最大化のテクニック
1. **価格予測の改善**:
   - 機械学習モデルの活用
   - 気象データとの相関分析
   - 需給バランス予測の精度向上

2. **ポートフォリオ最適化**:
   - JEPX vs 調整力の比率調整
   - リスク分散の考慮
   - 季節性の活用

3. **リアルタイム調整**:
   - インバランス価格の監視
   - 予測の動的更新
   - 市場状況に応じた戦略変更

### 実運用での注意点
1. **システム保護**:
   - バッテリー劣化の考慮
   - 深放電・過充電の回避
   - 温度管理との連携

2. **法的要件**:
   - 系統運用者との協定
   - 調整力の提供義務
   - 報告義務の遵守

3. **リスク管理**:
   - 価格変動リスク
   - システム故障リスク
   - 政策変更リスク

## 🛠️ カスタマイズと拡張

### パラメータのカスタマイズ
1. **託送料金の調整**:
   - エリア別の料金設定
   - 電圧階級別の設定
   - 時間帯別料金の考慮

2. **損失率の詳細設定**:
   - 充電効率 vs 放電効率
   - 温度依存性の考慮
   - 劣化による効率低下

### 外部システム連携
1. **データ連携**:
   - SCADA システムとの接続
   - 気象データの自動取得
   - 市場価格の自動更新

2. **制御システム連携**:
   - EMS (Energy Management System) との連携
   - PCS (Power Conditioning System) の制御
   - 保護システムとの協調

## 🙋‍♂️ よくある質問とAI対応例

### 収益分析関連の質問パターン

#### Q: 「最も収益性の高い時間帯はいつですか？」
**AIの回答方針**:
- 時間別収益データから具体的な時間を特定
- 収益が高い理由（価格差、調整力等）を説明
- 数値と割合で具体的に回答

#### Q: 「1日の平均収益はいくらですか？」
**AIの回答方針**:
- 総収益を日数で割った平均値を計算
- 収益の内訳（JEPX、EPRX1、EPRX3）を詳細化
- 月間・年間への換算も提示

#### Q: 「JEPX、EPRX1、EPRX3のどれが最も貢献していますか？」
**AIの回答方針**:
- 各市場の収益額と割合を算出
- 市場別の運用頻度も分析
- 収益構造の特徴を説明

### 運用分析関連の質問パターン

#### Q: 「バッテリーの稼働率はどの程度ですか？」
**AIの回答方針**:
- アクティブスロット数から稼働率を計算
- 充電・放電・調整力の時間配分を分析
- 待機時間とその理由を説明

#### Q: 「最もバッテリーを使用した日はいつですか？」
**AIの回答方針**:
- 日別の充放電量を集計・比較
- 最大使用日の市場状況を分析
- その日の運用パターンを詳細説明

#### Q: 「充電と放電の回数はそれぞれ何回ですか？」
**AIの回答方針**:
- アクション種別の集計
- サイクル数の計算
- 劣化への影響を評価

### パフォーマンス分析関連の質問パターン

#### Q: 「予測と実績の価格差が大きい日はありますか？」
**AIの回答方針**:
- 価格予測精度の分析
- 差異が大きい日付と原因の特定
- 収益への影響度を定量化

#### Q: 「損失率を下げるとどの程度収益が改善しますか？」
**AIの回答方針**:
- 現在の損失による収益影響を計算
- 損失率改善シナリオでの収益試算
- 投資対効果の概算

#### Q: 「このデータから改善できるポイントはありますか？」
**AIの回答方針**:
- データから非効率な運用パターンを特定
- パラメータ調整の提案
- 運用戦略の改善案

### トラブルシューティング関連の質問パターン

#### Q: 「最適化が遅い理由と改善方法を教えてください」
**AIの回答方針**:
- データサイズとパラメータ設定をチェック
- 具体的な改善手順を段階的に提示
- 処理時間の目安を提供

#### Q: 「CSVファイルの準備方法を教えてください」
**AIの回答方針**:
- 必須列と形式を詳細説明
- よくあるデータエラーとその対処法
- テンプレートファイルの活用方法

#### Q: 「エラーメッセージの意味と対処法を教えてください」
**AIの回答方針**:
- エラー種別の特定と原因説明
- 具体的な解決手順を段階的に提示
- 再発防止のための注意点

### 設定・操作関連の質問パターン

#### Q: 「パラメータの推奨設定を教えてください」
**AIの回答方針**:
- ユーザーのバッテリー規模や運用目的を確認
- システムに応じた推奨値を提示
- 設定理由と期待効果を説明

#### Q: 「グラフの見方を教えてください」
**AIの回答方針**:
- 各グラフの要素（軸、色、記号）を説明
- データの読み取り方を段階的に指導
- 分析のポイントを具体例で説明

#### Q: 「結果をエクスポートする方法は？」
**AIの回答方針**:
- エクスポート機能の場所と操作手順
- ファイル形式の選択基準
- エクスポートしたデータの活用方法

## 🔧 高度なカスタマイズと技術情報

### システム要件詳細
**オペレーティングシステム**:
- macOS 10.14 (Mojave) 以降
- Windows 10 (1903) 以降
- Ubuntu 18.04 LTS 以降

**ハードウェア要件**:
- CPU: 2コア以上（4コア推奨）
- メモリ: 4GB以上（8GB推奨）
- ストレージ: 2GB以上の空き容量
- ネットワーク: インターネット接続（API利用時）

**Python環境**:
- Python 3.8〜3.11対応
- PyQt6 6.0以降
- pandas 1.3以降
- numpy 1.20以降
- matplotlib 3.3以降
- PuLP 2.6以降

### 最適化エンジンの技術詳細

#### V1エンジンの特徴
**アルゴリズム**: 線形計画法（LP）
**ソルバー**: CBC (Coin-or Branch and Cut)
**制約簡素化**: EPRX1ブロック制約を簡略化
**メモリ使用量**: 中程度
**処理速度**: 最高速

#### V2エンジンの特徴
**アルゴリズム**: 混合整数線形計画法（MILP）
**確率的要素**: EPRX3発動率の確率的モデリング
**制約**: 完全なEPRX1ブロック制約
**メモリ使用量**: 高め
**処理速度**: 中程度

### データベース・ファイル構造

#### 設定ファイル
**場所**: システム依存の設定ディレクトリ
**形式**: QSettings（INI/レジストリ）
**バックアップ**: 自動バックアップ機能

#### ログファイル
**場所**: アプリケーションディレクトリ/logs/
**ローテーション**: 日次ローテーション
**保存期間**: 30日間（設定可能）

#### 一時ファイル
**最適化データ**: メモリ優先、必要時にディスクキャッシュ
**グラフ画像**: 一時的な PNG/SVG ファイル
**エクスポートデータ**: ユーザー指定場所に保存

### API連携仕様

#### OpenAI API連携
**対応モデル**: GPT-4、GPT-4 Turbo
**最大トークン**: 2000トークン/回答
**コンテキスト管理**: 会話履歴の保持
**エラーハンドリング**: 自動リトライ機能

#### 外部データ連携（将来拡張）
**気象データAPI**: 太陽光・風力予測用
**市場価格API**: リアルタイム価格取得
**SCADA連携**: 実績データの自動取込

### セキュリティとプライバシー

#### データ保護
**ローカル処理**: 機密データは端末内で処理
**API通信**: TLS 1.3暗号化
**データ保存**: 設定情報の暗号化保存

#### プライバシー配慮
**データ送信**: AIへの送信はユーザー明示的操作のみ
**ログ管理**: 個人情報は記録しない
**設定削除**: アンインストール時の完全削除

---
**更新日**: 2024年最新版 - 完全版
**対象バージョン**: デスクトップ版 v2.0、Web版 v1.0 
**文書バージョン**: v4.0 (パラメータ詳細化・技術情報拡充版)
**総ページ数**: 約50ページ相当
**主要改善点**: パラメータ設定詳細化、市場解説追加、技術仕様明記