# Battery Optimizer Desktop App v2.1 - 起動方法

## 🚀 ワンクリック起動（推奨）

### macOS / Linux
```bash
./start_app.sh
```

### Windows
```cmd
start_app.bat  # (将来追加予定)
```

## 📋 手動起動

1. **仮想環境の作成とアクティベート**
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # macOS/Linux
   # または
   venv\Scripts\activate  # Windows
   ```

2. **依存関係のインストール**
   ```bash
   pip install -r requirements.txt
   ```

3. **アプリケーションの起動**
   ```bash
   python main.py
   ```

## 🤖 NEW! AI機能の使用方法

### 1. OpenAI API設定
- **設定ボタン（⚙️）**: 画面右上のボタンをクリック
- **AI設定タブ**: OpenAI APIキーを入力
- **接続テスト**: 「APIテスト」ボタンで接続確認

### 2. AI Chat機能（v2.1強化版！）
- **AI Chatタブ**: 最適化後に利用可能
- **文脈理解**: 最適化結果を理解した上でQ&A
- **分析レポート**: 収益性、リスク、改善提案を自動生成
- **📊 送信データ確認**: AIに送信されるデータ内容を確認可能（NEW!）
- **データ保証**: 「データがない」回答を防止する強化システム

### 3. AI分析チャットの新機能（v2.1）

#### 📊 データ送信デバッグ機能
- **送信データ確認ボタン**: AIに送信される全データを3つのタブで確認
  - **サマリータブ**: 基本収益情報の確認
  - **詳細統計タブ**: 収益分析、期間情報、アクション分析
  - **生データタブ**: 実際の最適化結果データサンプル

#### 🎯 強化されたデータ認識
- **構造化データ送信**: 視覚的に分かりやすい形式でデータを送信
- **明確な境界線**: データセクションを視覚的に区別
- **データ保証システム**: AIが「データがない」と回答することを防止

#### 📝 詳細ログ出力
- **データ準備ログ**: 送信データの詳細をリアルタイムログで確認
- **統計情報ログ**: 収益データ、行数、カテゴリ数を表示
- **エラー診断**: 問題発生時の詳細情報

### 3. Revenue Details
- **専用タブ**: 4種類の収益分析グラフ
  - **時間別収益**: 1時間ごとの収益分布
  - **市場別貢献**: JEPX、EPRX1、EPRX3の収益内訳
  - **アクション分布**: 充電・放電・待機の割合
  - **日別トレンド**: 日ごとの収益推移

### 4. 託送料金・損失率データ管理（NEW!）
- **データ表示**: 全エリア・全電圧区分の託送料金と損失率を表形式で表示
- **リアルタイム編集**: ダブルクリックで値を直接編集
- **再エネ賦課金設定**: 全国一律の再エネ賦課金単価を変更可能
- **データ管理**: 保存・復元・再読み込み機能
- **即座反映**: 変更は次回最適化実行時から自動適用

## 🔧 トラブルシューティング

### v2.1で修正された問題

#### ✅ データ検証エラー（修正済み）
- **問題**: `test_clean_data.csv`で「有効なデータが残りません」エラー
- **修正**: pandas自動検出を優先、変数未定義エラーを解決
- **対応**: `2023/4/1`形式の単桁月日に完全対応

#### ✅ 日付形式対応（修正済み）
- **サポート形式**: `2023/4/1`, `2023-04-01`, `4/1/2023` など
- **自動検出**: pandas による柔軟な日付変換
- **マルチエンコーディング**: UTF-8, Shift_JIS, CP932, EUC-JP

### 一般的なトラブルシューティング

#### SoC（バッテリー残量）グラフが表示されない場合

1. **ログを確認**
   - アプリの左下のログエリアでエラーメッセージを確認
   - ターミナルでデバッグ情報を確認

2. **一般的な原因と解決法**
   - **原因**: 最適化が完了していない
     - **解決**: CSVデータを読み込んで「最適化実行」を完了させる
   
   - **原因**: データに`battery_level_kWh`列がない
     - **解決**: 最新のコードで再度最適化を実行
   
   - **原因**: 期間フィルターでデータが除外されている
     - **解決**: 「全期間」を選択して確認

#### Revenue Detailsが表示されない場合

1. **OpenAI ライブラリ確認**
   ```bash
   pip install openai
   ```

2. **最適化完了確認**
   - Revenue Detailsは最適化完了後に利用可能
   - エラーがあればAI Chatで🐛問題報告を利用

#### AI機能が利用できない場合

1. **APIキー設定確認**
   - ⚙️設定 → AI設定タブでAPIキーを設定
   - APIテストで接続を確認

2. **ネットワーク接続**
   - インターネット接続が必要
   - OpenAI APIへのアクセスを確認

#### 🆕 AI分析チャット「データがない」問題の解決法（v2.1対応）

**問題**: AIが「データを持っていない」「データがありません」と回答する

**解決手順**:

1. **📊 送信データ確認ボタンを使用**
   - AI Chatタブで「📊 送信データ確認」をクリック
   - 3つのタブでデータ内容を確認:
     - サマリー: 基本収益情報（総利益、JEPX/EPRX収益など）
     - 詳細統計: 収益分析、期間情報、アクション分析
     - 生データ: 実際の最適化結果サンプル

2. **ログでデータ送信状況を確認**
   ```
   ✅ 正常な場合のログ例:
   🤖 AI用データ準備完了: 全96行のデータを送信
   🤖 サマリーキー数: 8個
   🤖 統計データ準備: 4カテゴリ
   🤖 総収益データ: ¥123,456
   ```

3. **最適化実行状況の確認**
   - 最適化が完了していることを確認
   - エラーで中断していないかチェック
   - 必要に応じて再実行

4. **AIプロンプトの改善** (v2.1で自動対応済み)
   - 構造化されたデータ送信
   - 「データがない」回答の禁止指示
   - より効果的なシステムプロンプト

**よくある原因と解決法**:
- **原因**: 最適化が未完了 → **解決**: CSVファイル読み込み＋最適化実行
- **原因**: データ変換エラー → **解決**: ログでエラー確認、再実行
- **原因**: API制限 → **解決**: 送信データサイズの最適化（v2.1で改善）
- **原因**: システムプロンプト問題 → **解決**: v2.1で根本的改善済み

**デバッグのコツ**:
1. 左下のログエリアで🤖マークのメッセージを確認
2. 送信データ確認で実際のデータ内容をチェック
3. エラーがあれば🐛問題報告ボタンで管理者に報告

### GUI が表示されない場合

1. **macOS**
   - XQuartz がインストールされているか確認
   - `brew install --cask xquartz`

2. **Python バージョン確認**
   ```bash
   python3 --version
   # Python 3.8以上が推奨
   ```

3. **PyQt6 インストール確認**
   ```bash
   python -c "import PyQt6; print('PyQt6 OK')"
   ```

## 🎯 使用方法

### 1. CSVデータの準備
- **必須列**: `date`, `slot`, `JEPX_prediction`, `JEPX_actual`, `EPRX1_actual`, `EPRX3_actual`, `imbalance`
- **サンプルデータ**: `test_clean_data.csv` (96行のクリーンデータ)
- **テンプレート**: 「テンプレートダウンロード」ボタンでサンプルを取得

### 2. 最適化の実行
- **CSV読み込み**: 自動データ品質検証
- **パラメータ設定**: バッテリー容量、出力など
- **最適化実行**: フルモードで完全精度保証

### 3. 結果の確認
- **Graphsタブ**: バッテリー残量とJEPX価格（期間選択機能付き）
- **Revenue Detailsタブ**: 4種類の収益分析グラフ🆕
- **Dataタブ**: 詳細な最適化結果を表形式で表示
- **Summaryタブ**: 総利益や統計情報を表示
- **AI Chatタブ**: GPT-4oによる詳細分析🆕
- **託送料金・損失率タブ**: データ管理・編集🆕

## 🆕 v2.1新機能: 6タブインターフェース

### ⚙️ 統合設定
- **🤖 AI設定**: OpenAI APIキー管理
- **📧 メール設定**: 自動エラー報告用SMTP設定
- **⚙️ 一般**: ログレベル、自動保存設定

### 📊 Revenue Details（NEW!）
- **時間別収益**: バーチャート（1時間ごと）
- **市場別貢献**: パイチャート（JEPX/EPRX1/EPRX3）
- **アクション分布**: パイチャート（充電/放電/待機）
- **日別トレンド**: ラインチャート（利益・損失エリア）

### 💼 託送料金・損失率（NEW!）
- **全国9エリア対応**: 北海道〜九州の全エリアデータ
- **3電圧区分対応**: 特高圧（SHV）・高圧（HV）・低圧（LV）
- **編集可能項目**:
  - 損失率（%）: 送電時の電力損失
  - 託送基本料金（円/kW）: 容量に対する固定費
  - 託送使用料（円/kWh）: 使用量に対する従量費
  - 再エネ賦課金（円/kWh）: 全国一律賦課金

#### 使用方法
1. **データ確認**: 現在の託送料金・損失率を表形式で確認
2. **値の編集**: 編集したい項目をダブルクリック
3. **数値入力**: 新しい値を入力してEnterキー
4. **変更保存**: 「💾 変更保存」ボタンで変更を確定
5. **最適化実行**: 次回の最適化で新しい値が自動適用

## 💡 ヒント

### データ処理
- **マルチエンコーディング**: 日本語CSVファイルも自動対応
- **データ品質**: 7段階の自動検証プロセス
- **大量データ**: 期間選択機能で特定期間にフォーカス

### 分析機能
- **AI分析**: 「なぜこの時間に充電したのか？」などの質問に回答
- **Revenue分析**: 市場別の収益構造を詳細分析
- **トレンド把握**: 日別収益推移で長期傾向を確認

### プロダクション利用
- **結果保存**: CSVエクスポートでレポート作成
- **エラー報告**: 自動メール報告で運用監視
- **設定保存**: パラメータ自動保存で効率運用

## 📞 サポート

### 自動エラー報告
v2.1では自動エラー報告機能を搭載。問題発生時は：
1. **🐛問題報告ボタン**: AI Chatタブ内
2. **自動収集**: システム情報、ログ、エラー詳細
3. **メール送信**: 管理者への自動通知

### 手動サポート
問題が発生した場合は、以下の情報と共にお問い合わせください：
- OS とバージョン
- Python バージョン  
- エラーメッセージ
- ログの内容（ターミナル出力）
- 使用中のCSVファイル名

---

**🏢 Factlabel** | © 2024 | **Battery Optimizer v2.1** 🤖 